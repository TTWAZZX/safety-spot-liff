<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Spot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0f2f5; }
        #main-app, #registration-page { display: none; }
        .page { display: none; }
        .page.active { display: block; }
        .bottom-nav { box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .nav-link { color: #6c757d; }
        .nav-link.active { color: #0d6efd; }
        #admin-nav-item { color: #dc3545; }
        #admin-nav-item.active { color: #a1232e; }
        .badge-icon { width: 60px; height: 60px; }
        .badge-icon.locked { filter: grayscale(100%); opacity: 0.5; }
        .leaderboard-rank { font-size: 1.2rem; font-weight: bold; min-width: 40px; text-align: center; }
        .leaderboard-item .fa-trophy { color: #ffc107; }
        .table-responsive { max-height: 75vh; }
        .submission-card { background-color: #fff; border: 1px solid #e9ecef; }
        .like-btn .fa-heart { transition: color 0.2s, transform 0.2s; }
        .like-btn.liked .fa-heart { color: #dc3545; transform: scale(1.2); }
        .comment-list { max-height: 200px; overflow-y: auto; }
        .comment-item { background-color: #f8f9fa; font-size: 0.9rem; }
        .stat-card { border-left: 5px solid #0d6efd; }
        /* New Styles for Image Viewer */
        .activity-image { cursor: pointer; }
        #image-viewer-modal .modal-content { background: transparent; border: none; }
        #image-viewer-modal .modal-body { padding: 0; }
        #image-viewer-img { max-width: 100%; max-height: 85vh; display: block; margin: auto; }
    </style>
</head>
<body>
    <!-- Registration Page -->
    <div id="registration-page" class="container py-4"><div class="card shadow-sm border-0"><div class="card-body p-4"><h4 class="card-title text-center fw-bold mb-1">ลงทะเบียนใช้งาน</h4><p class="text-center text-muted mb-4">กรุณากรอกข้อมูลเพื่อเริ่มต้นใช้งาน</p><form id="registration-form"><div class="mb-3"><label for="fullName" class="form-label">ชื่อ-นามสกุล</label><input type="text" class="form-control" id="fullName" required placeholder="เช่น สมชาย ใจดี"></div><div class="mb-3"><label for="employeeId" class="form-label">รหัสพนักงาน</label><input type="text" class="form-control" id="employeeId" required placeholder="เช่น 12345"></div><button type="submit" class="btn btn-primary w-100 fw-bold mt-3 py-2">ยืนยันและเริ่มต้นใช้งาน</button></form></div></div></div>

    <!-- Main App -->
    <div id="main-app">
        <main class="container py-3 pb-5 mb-5">
            <!-- Home Page -->
            <div id="home-page" class="page active"><div class="d-flex align-items-center p-3 mb-4 bg-white rounded-3 shadow-sm"><img id="user-profile-pic" src="https://placehold.co/60x60" class="rounded-circle me-3" width="60" height="60"><div><p class="mb-0 text-muted small" id="user-employee-id">รหัส: ...</p><h5 class="mb-0 fw-bold" id="user-display-name">...</h5></div><div class="ms-auto text-end"><div class="fw-bold text-primary"><h4 class="mb-0" id="user-score">0</h4><small>คะแนน</small></div></div></div><h5 class="mb-3">กิจกรรมล่าสุด</h5><div id="latest-activities-list"><p class="text-center text-muted">กำลังโหลดกิจกรรม...</p></div></div>
            <!-- Activities Page -->
            <div id="activities-page" class="page"><h4 class="mb-3 fw-bold">กิจกรรมทั้งหมด</h4><div id="all-activities-list"></div></div>
            <!-- Leaderboard Page -->
            <div id="leaderboard-page" class="page"><h4 class="mb-3 fw-bold">กระดานผู้นำ</h4><div id="leaderboard-list"></div><div id="leaderboard-loading" class="text-center my-5"><div class="spinner-border" role="status"></div></div></div>
            <!-- Profile Page -->
            <div id="profile-page" class="page"><div class="card shadow-sm border-0"><div class="card-body text-center p-4"><img id="profile-page-pic" src="https://placehold.co/80x80" class="rounded-circle mb-3 border border-3 border-primary" width="80" height="80"><h4 id="profile-page-name" class="fw-bold">...</h4><p class="text-muted" id="profile-page-employee-id">รหัสพนักงาน: ...</p><p class="text-muted mb-4">คะแนนสะสม: <span class="fw-bold text-primary" id="profile-page-score">0</span></p><hr><h5 class="mt-4 mb-3">ป้ายรางวัลของฉัน</h5><div id="badges-container" class="d-flex justify-content-center flex-wrap gap-3"></div></div></div></div>
            <!-- Admin Page -->
            <div id="admin-page" class="page"><h4 class="fw-bold mb-3">Admin Panel</h4><div class="list-group"><a href="#" id="view-stats-btn" class="list-group-item list-group-item-action"><i class="fas fa-chart-line me-2"></i> ดูข้อมูลสรุป (Dashboard)</a><a href="#" id="manage-reports-btn" class="list-group-item list-group-item-action"><i class="fas fa-inbox me-2"></i> จัดการรายงานที่ส่งเข้ามา</a><a href="#" id="manage-activities-btn" class="list-group-item list-group-item-action"><i class="fas fa-tasks me-2"></i> จัดการกิจกรรม</a></div></div>
        </main>
        <nav class="navbar navbar-light bg-white fixed-bottom bottom-nav"><div class="container-fluid d-flex justify-content-around"><a href="#home" class="nav-link active text-center" data-page="home-page"><i class="fas fa-home fs-4"></i><div style="font-size:0.7rem;">หน้าหลัก</div></a><a href="#activities" class="nav-link text-center" data-page="activities-page"><i class="fas fa-tasks fs-4"></i><div style="font-size:0.7rem;">กิจกรรม</div></a><a href="#admin" class="nav-link text-center" data-page="admin-page" id="admin-nav-item" style="display:none;"><i class="fas fa-user-shield fs-4"></i><div style="font-size:0.7rem;">Admin</div></a><a href="#leaderboard" class="nav-link text-center" data-page="leaderboard-page"><i class="fas fa-trophy fs-4"></i><div style="font-size:0.7rem;">อันดับ</div></a><a href="#profile" class="nav-link text-center" data-page="profile-page"><i class="fas fa-user fs-4"></i><div style="font-size:0.7rem;">โปรไฟล์</div></a></div></nav>
    </div>
    
    <!-- Modals -->
    <div class="modal fade" id="submission-modal" tabindex="-1">...</div>
    <div class="modal fade" id="admin-reports-modal" tabindex="-1">...</div>
    <div class="modal fade" id="admin-activities-modal" tabindex="-1">...</div>
    <div class="modal fade" id="activity-form-modal" tabindex="-1">...</div>
    <div class="modal fade" id="activity-detail-modal" tabindex="-1">...</div>
    <div class="modal fade" id="admin-stats-modal" tabindex="-1">...</div>
    <!-- (All previous modals are here, hidden for brevity) -->

    <!-- NEW: Image Viewer Modal -->
    <div class="modal fade" id="image-viewer-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img src="" id="image-viewer-img" alt="Image Preview">
                </div>
            </div>
        </div>
    </div>


    <!-- JS Libraries -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // ... (The top part of your script is the same) ...
        const SERVER_URL = "YOUR_APPS_SCRIPT_URL";
        const LIFF_ID = "YOUR_LIFF_ID";
        let lineProfile = {}; 
        let allModals = {};

        $(document).ready(function() {
            // Add the new modal to the list
            ['submission', 'admin-reports', 'admin-activities', 'activity-form', 'activity-detail', 'admin-stats', 'image-viewer'].forEach(id => {
                allModals[id] = new bootstrap.Modal(document.getElementById(`${id}-modal`));
            });
            initializeApp();
            $('a[data-page="leaderboard-page"]').on('click', loadLeaderboard);
            $('a[data-page="profile-page"]').on('click', loadUserBadges);
        });

        // ... (initializeApp, showMainApp, callApi functions are the same as the previous version) ...

        // --- EVENT LISTENERS ---
        // ... (All previous listeners are here) ...

        // NEW: Image click listener
        $(document).on('click', '.activity-image', function() {
            const imageUrl = $(this).attr('src');
            $('#image-viewer-img').attr('src', imageUrl);
            allModals['image-viewer'].show();
        });


        // --- UI & DATA LOADING FUNCTIONS ---
        // MODIFIED: displayActivitiesUI function
        function displayActivitiesUI(activities){
            const lists = $('#latest-activities-list, #all-activities-list');
            lists.empty();
            if(!activities || activities.length === 0){
                lists.html('<p class="text-center text-muted">ยังไม่มีกิจกรรม</p>');
                return;
            } 
            activities.forEach(act => {
                // Added 'activity-image' class to the img tag
                const cardHtml = `
                <div class="card shadow-sm mb-3">
                    <img src="${act.imageUrl}" class="card-img-top activity-image" style="height:150px;object-fit:cover;" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e9ecef/6c757d?text=Image';">
                    <div class="card-body">
                        <h5 class="card-title fw-bold">${act.title}</h5>
                        <p class="card-text text-muted small">${act.description}</p>
                        <button class="btn btn-outline-primary w-100 fw-bold py-2 btn-view-activity" data-activity-id="${act.activityId}" data-activity-title="${act.title}">
                            <i class="fas fa-eye me-1"></i> ดูรายงานและเข้าร่วม
                        </button>
                    </div>
                </div>`;
                lists.append(cardHtml);
            });
        }

        async function initializeApp() {
            try {
                Swal.fire({ title: 'กำลังเริ่มต้น...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                lineProfile = await liff.getProfile();
                const result = await callApi('getUserProfile', { lineUserId: lineProfile.userId });
                if (result.registered) {
                    showMainApp(result.user);
                } else {
                    Swal.close();
                    $('#registration-page').fadeIn();
                }
            } catch (error) {
                console.error("Initialization failed:", error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเริ่มต้นแอปพลิเคชันได้ กรุณาลองใหม่อีกครั้ง', 'error');
            }
        }

        async function showMainApp(userData) {
            updateUserInfoUI(userData);
            if (userData.isAdmin) {
                $('#admin-nav-item').show();
                // Setup admin buttons
                $('#view-stats-btn').on('click', () => { loadAdminStats(); allModals['admin-stats'].show(); });
                $('#manage-reports-btn').on('click', () => { loadPendingSubmissions(); allModals['admin-reports'].show(); });
                $('#manage-activities-btn').on('click', () => { loadAllActivitiesForAdmin(); allModals['admin-activities'].show(); });
                $('#create-activity-btn').on('click', () => { 
                    $('#activity-form-title').text('สร้างกิจกรรมใหม่'); 
                    $('#activity-form')[0].reset(); 
                    $('#form-activity-id').val(''); 
                    allModals['activity-form'].show(); 
                });
            }
            const activities = await callApi('getActivities');
            displayActivitiesUI(activities);
            $('#main-app').fadeIn();
            Swal.close();
        }

function callApi(action, payload = {}, method = 'GET') { // method จะไม่ถูกใช้แล้ว แต่ปล่อยไว้ได้
    return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) {
            delete window[callbackName];
            if(script && script.parentNode) document.body.removeChild(script);
            if (data.status === 'success') {
                resolve(data.data);
            } else {
                console.error('API Error:', data.message);
                reject(new Error(data.message));
            }
        };
        
        // --- เหลือแค่ส่วนนี้พอ ---
        let script = document.createElement('script');
        const payloadStr = encodeURIComponent(JSON.stringify(payload));
        script.src = `${SERVER_URL}?callback=${callbackName}&action=${action}&payload=${payloadStr}`;
        document.body.appendChild(script);
        // --- สิ้นสุดส่วนที่เหลือ ---
    });
}
        
        // --- EVENT LISTENERS ---
        $('.nav-link').on('click',function(e){e.preventDefault();const pageId=$(this).data('page');if(pageId){$('.nav-link').removeClass('active');$(this).addClass('active');$('.page').removeClass('active');$('#'+pageId).addClass('active');}});
        $('#registration-form').on('submit',async function(e){e.preventDefault();const fullName=$('#fullName').val().trim();const employeeId=$('#employeeId').val().trim();if(!fullName||!employeeId){Swal.fire('ข้อมูลไม่ครบ','กรุณากรอกข้อมูลให้ครบถ้วน','warning');return;} Swal.fire({title:'กำลังบันทึก...',didOpen:()=>Swal.showLoading()});try{const newUser=await callApi("registerUser",{lineUserId:lineProfile.userId,displayName:lineProfile.displayName,pictureUrl:lineProfile.pictureUrl,fullName:fullName,employeeId:employeeId}, 'POST');$('#registration-page').hide();await showMainApp(newUser);Swal.fire('สำเร็จ!','ลงทะเบียนเรียบร้อย','success');}catch(error){Swal.fire('ผิดพลาด','ไม่สามารถลงทะเบียนได้','error');}});
        
        // --- Submission Flow ---
        $(document).on('click','.btn-view-activity', function() {
            const activityId = $(this).data('activity-id');
            const activityTitle = $(this).data('activity-title');
            loadAndShowActivityDetails(activityId, activityTitle);
        });

        $('.btn-join-from-detail').on('click', function() {
            const activityId = $(this).data('activity-id');
            const activityTitle = $(this).data('activity-title');
            $('#activityId-input').val(activityId);
            $('#activity-title-modal').text(activityTitle);
            allModals['submission'].show();
        });

        $('#submission-form').on('submit', async function(e){e.preventDefault();Swal.fire({title:'กำลังส่ง...',didOpen:()=>Swal.showLoading()});const payload={lineUserId:lineProfile.userId,activityId:$('#activityId-input').val(),description:$('#description-input').val().trim()};callApi('submitReport',payload,'POST').then(()=>{allModals.submission.hide();$('#submission-form')[0].reset();Swal.fire('สำเร็จ!','รายงานของคุณถูกส่งแล้ว','success');}).catch(error=>{Swal.fire('ผิดพลาด','ไม่สามารถส่งรายงานได้','error');});});

        // --- Social Features Listeners ---
        $(document).on('click', '.like-btn', function() {
            const btn = $(this);
            const submissionId = btn.data('submission-id');
            btn.prop('disabled', true);
            callApi('likeSubmission', { submissionId, lineUserId: lineProfile.userId }, 'POST').then(result => {
                const countSpan = btn.find('.like-count');
                let currentCount = parseInt(countSpan.text());
                if(result.status === 'liked') {
                    btn.addClass('liked');
                    countSpan.text(currentCount + 1);
                } else {
                    btn.removeClass('liked');
                    countSpan.text(currentCount - 1);
                }
            }).always(() => btn.prop('disabled', false));
        });

        $(document).on('submit', '.comment-form', function(e) {
            e.preventDefault();
            const form = $(this);
            const submissionId = form.data('submission-id');
            const input = form.find('.comment-input');
            const commentText = input.val().trim();
            if(!commentText) return;

            const submitBtn = form.find('button');
            submitBtn.prop('disabled', true);

            callApi('addComment', { submissionId, lineUserId: lineProfile.userId, commentText }, 'POST').then(() => {
                const newComment = `<div class="comment-item p-2 rounded mb-2 d-flex"><img src="${lineProfile.pictureUrl}" class="rounded-circle me-2" width="24" height="24"><div><strong>คุณ:</strong> ${commentText}</div></div>`;
                form.siblings('.comment-list').append(newComment);
                input.val('');
            }).catch(e => {
                Swal.fire('ผิดพลาด', 'ไม่สามารถเพิ่มความคิดเห็นได้', 'error');
            }).always(() => {
                submitBtn.prop('disabled', false);
            });
        });

        // --- Admin Listeners ---
        $('#activity-form').on('submit', async function(e){e.preventDefault();Swal.fire({title:'กำลังบันทึก...',didOpen:()=>Swal.showLoading()});const payload={activityId:$('#form-activity-id').val(),title:$('#form-activity-title').val(),description:$('#form-activity-desc').val(),imageUrl:$('#form-activity-image').val()};const action=payload.activityId?'updateActivity':'createActivity';try{await callApi(action,payload,'POST');allModals['activity-form'].hide();Swal.fire('สำเร็จ!','บันทึกกิจกรรมเรียบร้อย','success');loadAllActivitiesForAdmin();}catch(e){Swal.fire('ผิดพลาด','ไม่สามารถบันทึกได้','error');}});
        $(document).on('click', '.btn-approve, .btn-reject', function(){const btn=$(this);const action=btn.hasClass('btn-approve')?'approveSubmission':'rejectSubmission';const id=btn.data('id');const row=btn.data('row');btn.prop('disabled',true).parent().find('button').prop('disabled',true);btn.html('<span class="spinner-border spinner-border-sm"></span>');callApi(action,{submissionId:id,rowIndex:row},'POST').then(()=>{ $(`#row-${id}`).fadeOut(500,function(){$(this).remove();});}).catch(e=>{Swal.fire('Error','เกิดข้อผิดพลาด','error');btn.prop('disabled',false).parent().find('button').prop('disabled',false);btn.html(btn.hasClass('btn-approve')?'✓':'✗');});});
        $(document).on('click', '.btn-edit-activity', function(){const data=JSON.parse(decodeURIComponent($(this).data('activity-data')));$('#activity-form-title').text('แก้ไขกิจกรรม');$('#form-activity-id').val(data.activityId);$('#form-activity-title').val(data.title);$('#form-activity-desc').val(data.description);$('#form-activity-image').val(data.imageUrl);allModals['activity-form'].show();});
        $(document).on('click', '.btn-toggle-activity', function(){const btn=$(this);const id=btn.data('id');btn.prop('disabled',true);callApi('toggleActivityStatus',{activityId:id},'GET').then(res=>{btn.prop('disabled',false);loadAllActivitiesForAdmin();}).catch(()=>btn.prop('disabled',false));});

        // --- UI & DATA LOADING FUNCTIONS ---
        function updateUserInfoUI(userData){$('#user-profile-pic, #profile-page-pic').attr('src',userData.pictureUrl);$('#user-display-name, #profile-page-name').text(userData.fullName);$('#user-employee-id').text(`รหัส: ${userData.employeeId}`);$('#profile-page-employee-id').text(`รหัสพนักงาน: ${userData.employeeId}`);$('#user-score, #profile-page-score').text(userData.totalScore);}
        function displayActivitiesUI(activities){const lists=$('#latest-activities-list, #all-activities-list');lists.empty();if(!activities||activities.length===0){lists.html('<p class="text-center text-muted">ยังไม่มีกิจกรรม</p>');return;} activities.forEach(act=>{const cardHtml=`<div class="card shadow-sm mb-3"><img src="${act.imageUrl}" class="card-img-top" style="height:150px;object-fit:cover;" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e9ecef/6c757d?text=Image';"><div class="card-body"><h5 class="card-title fw-bold">${act.title}</h5><p class="card-text text-muted small">${act.description}</p><button class="btn btn-outline-primary w-100 fw-bold py-2 btn-view-activity" data-activity-id="${act.activityId}" data-activity-title="${act.title}"><i class="fas fa-eye me-1"></i> ดูรายงานและเข้าร่วม</button></div></div>`;lists.append(cardHtml);});}
        
        async function loadAndShowActivityDetails(activityId, activityTitle) {
            $('#activity-detail-title').text(activityTitle);
            $('.btn-join-from-detail').data('activity-id', activityId).data('activity-title', activityTitle);
            const container = $('#submissions-container');
            $('#submissions-loading').show();
            container.empty();
            allModals['activity-detail'].show();

            try {
                const submissions = await callApi('getSubmissionsForActivity', { activityId, lineUserId: lineProfile.userId });
                renderSubmissions(submissions);
            } catch (error) {
                container.html('<p class="text-center text-danger">ไม่สามารถโหลดข้อมูลรายงานได้</p>');
            } finally {
                $('#submissions-loading').hide();
            }
        }

        function renderSubmissions(submissions) {
            const container = $('#submissions-container');
            container.empty();
            if (submissions.length === 0) {
                container.html('<p class="text-center text-muted mt-5">ยังไม่มีใครส่งรายงานสำหรับกิจกรรมนี้<br>มาเป็นคนแรกกันเถอะ!</p>');
                return;
            }
            submissions.forEach(sub => {
                const likedClass = sub.didLike ? 'liked' : '';
                let commentsHtml = sub.comments.map(c => `
                    <div class="comment-item p-2 rounded mb-2 d-flex">
                        <img src="${c.commenter.pictureUrl}" class="rounded-circle me-2" width="24" height="24" onerror="this.onerror=null;this.src='https://placehold.co/24x24';">
                        <div><strong>${c.commenter.fullName}:</strong> ${c.commentText}</div>
                    </div>
                `).join('');

                const card = `
                <div class="card submission-card shadow-sm mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <img src="${sub.submitter.pictureUrl}" class="rounded-circle me-2" width="40" height="40" onerror="this.onerror=null;this.src='https://placehold.co/40x40';">
                            <div>
                                <h6 class="mb-0">${sub.submitter.fullName}</h6>
                                <small class="text-muted">${new Date(sub.createdAt).toLocaleString()}</small>
                            </div>
                        </div>
                        <p class="card-text">${sub.description}</p>
                    </div>
                    <div class="card-footer bg-white d-flex justify-content-start align-items-center gap-3">
                        <button class="btn btn-sm btn-link text-decoration-none like-btn ${likedClass}" data-submission-id="${sub.submissionId}">
                            <i class="fas fa-heart"></i> <span class="like-count">${sub.likes}</span>
                        </button>
                        <div class="text-muted"><i class="fas fa-comment"></i> ${sub.comments.length}</div>
                    </div>
                    <div class="card-footer bg-white">
                        <div class="comment-list mb-2">${commentsHtml}</div>
                        <form class="d-flex comment-form" data-submission-id="${sub.submissionId}">
                            <input type="text" class="form-control form-control-sm comment-input" placeholder="แสดงความคิดเห็น...">
                            <button type="submit" class="btn btn-primary btn-sm ms-2">ส่ง</button>
                        </form>
                    </div>
                </div>`;
                container.append(card);
            });
        }

        function loadLeaderboard(){const list=$('#leaderboard-list');const loading=$('#leaderboard-loading');list.empty();loading.show();callApi('getLeaderboard').then(users=>{loading.hide();if(users.length===0){list.html('<p class="text-center text-muted">ยังไม่มีข้อมูล</p>');return;} users.forEach((user,index)=>{const rank=index+1;let rankDisplay;if(rank===1)rankDisplay='<i class="fas fa-trophy"></i>';else if(rank===2)rankDisplay='<i class="fas fa-medal text-secondary"></i>';else if(rank===3)rankDisplay='<i class="fas fa-medal" style="color:#cd7f32;"></i>';else rankDisplay=rank;const itemHtml=`<div class="d-flex align-items-center p-2 mb-2 bg-white rounded-3 shadow-sm"><div class="leaderboard-rank me-3">${rankDisplay}</div><img src="${user.pictureUrl}" class="rounded-circle me-3" width="45" height="45" onerror="this.onerror=null;this.src='https://placehold.co/45x45';"><div class="flex-grow-1"><div class="fw-bold">${user.fullName}</div></div><div class="fw-bold text-primary">${user.totalScore} คะแนน</div></div>`;list.append(itemHtml);});}).catch(error=>{loading.hide();list.html('<p class="text-center text-danger">โหลดข้อมูลไม่ได้</p>');});}
        function loadUserBadges(){const container=$('#badges-container');container.html('<div class="spinner-border"></div>');callApi('getUserBadges',{lineUserId:lineProfile.userId}).then(badges=>{container.empty();if(badges.length===0){container.html('<p class="text-muted">ยังไม่มีป้ายรางวัล</p>');return;} badges.forEach(b=>{const lockClass=b.isEarned?'':'locked';const html=`<div class="text-center" title="${b.name}: ${b.desc}"><img src="${b.img}" class="badge-icon ${lockClass}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/e9ecef/6c757d?text=Badge';"><div class="small">${b.name}</div></div>`;container.append(html);});}).catch(e=>{container.html('<p class="text-danger">โหลดป้ายรางวัลไม่ได้</p>')})}
        function loadPendingSubmissions(){const tableBody=$('#submissions-table-body');$('#reports-loading').show();$('#no-reports-message').hide();tableBody.empty();callApi('getPendingSubmissions').then(subs=>{ $('#reports-loading').hide();$('#pending-count-modal').text(subs.length);if(subs.length===0){$('#no-reports-message').show();return;} subs.forEach(s=>{const row=`<tr id="row-${s.submissionId}"><td><div class="fw-bold">${s.submitter.fullName}</div><small class="text-muted">${new Date(s.createdAt).toLocaleString()}</small></td><td>${s.description}</td><td><button class="btn btn-success btn-sm btn-approve" data-id="${s.submissionId}" data-row="${s.rowIndex}">✓</button><button class="btn btn-danger btn-sm btn-reject" data-id="${s.submissionId}" data-row="${s.rowIndex}">✗</button></td></tr>`;tableBody.append(row);});});}
        function loadAllActivitiesForAdmin(){const list=$('#activities-list-admin');list.html('<div class="spinner-border"></div>');callApi('getAllActivities').then(acts=>{list.empty();acts.forEach(a=>{const statusBadge=a.status==='active'?'bg-success':'bg-secondary';const btnText=a.status==='active'?'Deactivate':'Activate';const btnClass=a.status==='active'?'btn-secondary':'btn-success';const activityData = encodeURIComponent(JSON.stringify(a)); const html=`<div class="card mb-2"><div class="card-body d-flex align-items-center"><div><span class="badge ${statusBadge} me-2">${a.status}</span><strong>${a.title}</strong></div><div class="ms-auto"><button class="btn btn-sm btn-primary btn-edit-activity me-1" data-activity-data='${activityData}'>Edit</button><button class="btn btn-sm ${btnClass} btn-toggle-activity" data-id="${a.activityId}">${btnText}</button></div></div></div>`;list.append(html);});});}
        async function loadAdminStats() {
            const container = $('#stats-container');
            $('#stats-loading').show();
            container.empty();
            try {
                const stats = await callApi('getDashboardStats');
                const statsHtml = `
                    <div class="col-md-6"><div class="card stat-card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">ผู้ใช้งานทั้งหมด</h6><h4 class="card-title">${stats.totalUsers} คน</h4></div></div></div>
                    <div class="col-md-6"><div class="card stat-card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">รายงานทั้งหมด</h6><h4 class="card-title">${stats.totalSubmissions} รายการ</h4></div></div></div>
                    <div class="col-md-6"><div class="card stat-card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">รายงานวันนี้</h6><h4 class="card-title">${stats.submissionsToday} รายการ</h4></div></div></div>
                    <div class="col-md-6"><div class="card stat-card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">กิจกรรมที่ถูกรายงานมากที่สุด</h6><h5 class="card-title small">${stats.mostReportedActivity}</h5></div></div></div>
                `;
                container.html(statsHtml);
            } catch(e) {
                container.html('<p class="text-center text-danger">ไม่สามารถโหลดข้อมูลสรุปได้</p>');
            } finally {
                $('#stats-loading').hide();
            }
        }
    </script>
</body>
</html>
