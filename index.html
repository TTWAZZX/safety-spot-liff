<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Spot</title>
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0f2f5; }
        #main-app, #registration-page { display: none; }
        .page { display: none; }
        .page.active { display: block; }
        .bottom-nav { box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .nav-link { color: #6c757d; }
        .nav-link.active { color: #0d6efd; }
        #admin-nav-item { color: #dc3545; }
        #admin-nav-item.active { color: #a1232e; }
        .leaderboard-rank { font-size: 1.2rem; font-weight: bold; min-width: 40px; text-align: center; }
        .leaderboard-item .fa-trophy { color: #ffc107; }
        .table-responsive { max-height: 75vh; }
    </style>
</head>
<body>
    <!-- Registration Page -->
    <div id="registration-page" class="container py-4">
        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                <h4 class="card-title text-center fw-bold mb-1">ลงทะเบียนใช้งาน</h4>
                <p class="text-center text-muted mb-4">กรุณากรอกข้อมูลเพื่อเริ่มต้นใช้งาน</p>
                <form id="registration-form">
                    <div class="mb-3">
                        <label for="fullName" class="form-label">ชื่อ-นามสกุล</label>
                        <input type="text" class="form-control" id="fullName" required placeholder="เช่น สมชาย ใจดี">
                    </div>
                    <div class="mb-3">
                        <label for="employeeId" class="form-label">รหัสพนักงาน</label>
                        <input type="text" class="form-control" id="employeeId" required placeholder="เช่น 12345">
                    </div>
                    <button type="submit" class="btn btn-primary w-100 fw-bold mt-3 py-2">ยืนยันและเริ่มต้นใช้งาน</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app">
        <main class="container py-3 pb-5 mb-5">
            <!-- Page 1: Home -->
            <div id="home-page" class="page active">
                <div class="d-flex align-items-center p-3 mb-4 bg-white rounded-3 shadow-sm">
                    <img id="user-profile-pic" src="https://placehold.co/60x60" class="rounded-circle me-3" width="60" height="60">
                    <div>
                        <p class="mb-0 text-muted small" id="user-employee-id">รหัส: ...</p>
                        <h5 class="mb-0 fw-bold" id="user-display-name">...</h5>
                    </div>
                    <div class="ms-auto text-end">
                        <div class="fw-bold text-primary">
                            <h4 class="mb-0" id="user-score">0</h4>
                            <small>คะแนน</small>
                        </div>
                    </div>
                </div>
                <h5 class="mb-3">กิจกรรมล่าสุด</h5>
                <div id="latest-activities-list"><p class="text-center text-muted">กำลังโหลดกิจกรรม...</p></div>
            </div>

            <!-- Page 2: Activities -->
            <div id="activities-page" class="page">
                <h4 class="mb-3 fw-bold">กิจกรรมทั้งหมด</h4>
                <div id="all-activities-list"></div>
            </div>

            <!-- Page 3: Leaderboard -->
            <div id="leaderboard-page" class="page">
                <h4 class="mb-3 fw-bold">กระดานผู้นำ</h4>
                <div id="leaderboard-list"></div>
                <div id="leaderboard-loading" class="text-center my-5">
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                </div>
            </div>

            <!-- Page 4: Profile -->
            <div id="profile-page" class="page">
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center p-4">
                        <img id="profile-page-pic" src="https://placehold.co/80x80" class="rounded-circle mb-3 border border-3 border-primary" width="80" height="80">
                        <h4 id="profile-page-name" class="fw-bold">...</h4>
                        <p class="text-muted" id="profile-page-employee-id">รหัสพนักงาน: ...</p>
                        <p class="text-muted mb-4">คะแนนสะสม: <span class="fw-bold text-primary" id="profile-page-score">0</span></p>
                    </div>
                </div>
            </div>

            <!-- Page 5: Admin Page -->
            <div id="admin-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="fw-bold">จัดการรายงาน (<span id="pending-count">0</span>)</h4>
                    <button class="btn btn-primary" id="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark">
                                    <tr><th>ID</th><th>รายละเอียด</th><th>Actions</th></tr>
                                </thead>
                                <tbody id="submissions-table-body"></tbody>
                            </table>
                        </div>
                        <div id="loading-spinner" class="text-center my-4 d-none"><div class="spinner-border" role="status"></div></div>
                        <div id="no-data-message" class="text-center my-4 d-none"><p class="text-muted">ไม่มีรายการที่รอตรวจสอบ</p></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation Bar -->
        <nav class="navbar navbar-light bg-white fixed-bottom bottom-nav">
            <div class="container-fluid d-flex justify-content-around">
                <a href="#home" class="nav-link active text-center" data-page="home-page"><i class="fas fa-home fs-4"></i><div style="font-size: 0.7rem;">หน้าหลัก</div></a>
                <a href="#activities" class="nav-link text-center" data-page="activities-page"><i class="fas fa-tasks fs-4"></i><div style="font-size: 0.7rem;">กิจกรรม</div></a>
                <a href="#admin" class="nav-link text-center" data-page="admin-page" id="admin-nav-item" style="display: none;"><i class="fas fa-user-shield fs-4"></i><div style="font-size: 0.7rem;">Admin</div></a>
                <a href="#leaderboard" class="nav-link text-center" data-page="leaderboard-page"><i class="fas fa-trophy fs-4"></i><div style="font-size: 0.7rem;">อันดับ</div></a>
                <a href="#profile" class="nav-link text-center" data-page="profile-page"><i class="fas fa-user fs-4"></i><div style="font-size: 0.7rem;">โปรไฟล์</div></a>
            </div>
        </nav>
    </div>
    
    <!-- Modal: Submission Form -->
    <div class="modal fade" id="submission-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="submissionModalLabel">เข้าร่วมกิจกรรม</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="submission-form">
                        <input type="hidden" id="activityId-input"><h5 id="activity-title-modal" class="fw-bold mb-3"></h5>
                        <div class="mb-3"><label for="description-input" class="form-label">รายละเอียดจุดเสี่ยงที่พบ</label><textarea class="form-control" id="description-input" rows="4" required placeholder="อธิบายสิ่งที่พบเจอ..."></textarea></div>
                        <div class="mb-3"><label for="photo-input" class="form-label">แนบรูปภาพ (ถ้ามี)</label><input class="form-control" type="file" id="photo-input" accept="image/*"></div>
                        <button type="submit" class="btn btn-primary w-100 fw-bold mt-3 py-2">ส่งรายงาน</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Libraries -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        const SERVER_URL = "https://script.google.com/macros/s/AKfycbwxqz4oyc5oOP_81fCeXbINoW-WLOv0l2Tmb3ZTc13B944uY8q8P1V1JPbdzGP4LTnexw/exec";
        const LIFF_ID = "2007053300-9xLKdwZp"; // ❗️❗️ อย่าลืมเปลี่ยนเป็น LIFF ID ของคุณ
        let lineProfile = {}; 
        let submissionModal;

        $(document).ready(function() {
            submissionModal = new bootstrap.Modal(document.getElementById('submission-modal'));
            initializeApp();
            $('a[data-page="leaderboard-page"]').on('click', loadLeaderboard);
        });

        async function initializeApp() {
            try {
                Swal.fire({ title: 'กำลังเริ่มต้น...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                    return; 
                }
                lineProfile = await liff.getProfile();
                const result = await callApi('getUserProfile', { lineUserId: lineProfile.userId });
                if (result.registered) { 
                    showMainApp(result.user); 
                } else { 
                    Swal.close(); 
                    $('#registration-page').fadeIn(); 
                }
            } catch (error) { 
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดแอปได้', 'error'); 
            }
        }

        async function showMainApp(userData) {
            updateUserInfoUI(userData);
            if (userData.isAdmin) {
                $('#admin-nav-item').show();
                $('#admin-nav-item').on('click', loadPendingSubmissions);
                $('#refresh-btn').on('click', loadPendingSubmissions);
            }
            const activities = await callApi('getActivities');
            displayActivitiesUI(activities);
            $('#main-app').fadeIn();
            Swal.close();
        }

        function loadLeaderboard() {
            const list = $('#leaderboard-list');
            const loading = $('#leaderboard-loading');
            list.empty();
            loading.show();
            callApi('getLeaderboard').then(users => {
                loading.hide();
                if (users.length === 0) { 
                    list.html('<p class="text-center text-muted">ยังไม่มีข้อมูลคะแนน</p>'); 
                    return; 
                }
                users.forEach((user, index) => {
                    const rank = index + 1;
                    let rankDisplay;
                    if (rank === 1) rankDisplay = '<i class="fas fa-trophy"></i>';
                    else if (rank === 2) rankDisplay = '<i class="fas fa-medal text-secondary"></i>';
                    else if (rank === 3) rankDisplay = '<i class="fas fa-medal" style="color: #cd7f32;"></i>';
                    else rankDisplay = rank;
                    const itemHtml = `<div class="d-flex align-items-center p-2 mb-2 bg-white rounded-3 shadow-sm leaderboard-item"><div class="leaderboard-rank me-3">${rankDisplay}</div><img src="${user.pictureUrl}" class="rounded-circle me-3" width="45" height="45"><div class="flex-grow-1"><div class="fw-bold">${user.fullName}</div></div><div class="fw-bold text-primary">${user.totalScore} คะแนน</div></div>`;
                    list.append(itemHtml);
                });
            }).catch(error => { 
                loading.hide(); 
                list.html('<p class="text-center text-danger">ไม่สามารถโหลดข้อมูลได้</p>'); 
            });
        }
        
        function callApi(action, payload = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    if (data.status === 'success') {
                        resolve(data.data);
                    } else {
                        reject(new Error(data.message));
                    }
                };
                const script = document.createElement('script');
                const payloadStr = encodeURIComponent(JSON.stringify(payload));
                script.src = `${SERVER_URL}?callback=${callbackName}&action=${action}&payload=${payloadStr}`;
                script.onerror = () => reject(new Error('Failed to load API script.'));
                document.body.appendChild(script);
            });
        }
        
        function loadPendingSubmissions() {
            const tableBody = $("#submissions-table-body");
            const loadingSpinner = $("#loading-spinner");
            const noDataMessage = $("#no-data-message");
            const pendingCount = $("#pending-count");
            tableBody.empty();
            loadingSpinner.removeClass("d-none");
            noDataMessage.addClass("d-none");
            pendingCount.text("...");
            callApi("getPendingSubmissions").then(submissions => {
                loadingSpinner.addClass("d-none");
                pendingCount.text(submissions.length);
                if (submissions.length === 0) {
                    noDataMessage.removeClass("d-none");
                } else {
                    submissions.forEach(sub => {
                        const row = `<tr id="row-${sub.submissionId}"><td class="small">${sub.submissionId.substring(0,8)}...</td><td><div class="small text-muted">User: ${sub.lineUserId.substring(0,10)}...</div>${sub.description}</td><td><button class="btn btn-success btn-sm btn-approve" data-id="${sub.submissionId}" data-row="${sub.rowIndex}">✓</button><button class="btn btn-danger btn-sm btn-reject" data-id="${sub.submissionId}" data-row="${sub.rowIndex}">✗</button></td></tr>`;
                        tableBody.append(row);
                    });
                }
            }).catch(error => {
                loadingSpinner.addClass("d-none");
                Swal.fire("Error", "ไม่สามารถโหลดข้อมูล Admin ได้", "error");
            });
        }

        $(document).on("click", ".btn-approve, .btn-reject", function() {
            const button = $(this);
            const action = button.hasClass("btn-approve") ? "approveSubmission" : "rejectSubmission";
            const submissionId = button.data("id");
            const rowIndex = button.data("row");
            button.prop("disabled", true).parent().find("button").prop("disabled", true);
            button.html('<span class="spinner-border spinner-border-sm"></span>');
            callApi(action, { submissionId: submissionId, rowIndex: rowIndex }).then(() => {
                $(`#row-${submissionId}`).fadeOut(500, function() {
                    $(this).remove();
                    const currentCount = parseInt($("#pending-count").text()) - 1;
                    $("#pending-count").text(currentCount);
                });
            }).catch(error => {
                Swal.fire("Error", "เกิดข้อผิดพลาดในการดำเนินการ", "error");
                button.prop("disabled", false).parent().find("button").prop("disabled", false);
                button.html(button.hasClass("btn-approve") ? "✓" : "✗");
            });
        });

        $("#registration-form").on("submit", async function(e) {
            e.preventDefault();
            const fullName = $("#fullName").val().trim();
            const employeeId = $("#employeeId").val().trim();
            if (!fullName || !employeeId) {
                Swal.fire("ข้อมูลไม่ครบ", "กรุณากรอกข้อมูลให้ครบถ้วน", "warning");
                return;
            }
            try {
                Swal.fire({ title: "กำลังบันทึก...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                const newUser = await callApi("registerUser", {
                    lineUserId: lineProfile.userId,
                    displayName: lineProfile.displayName,
                    pictureUrl: lineProfile.pictureUrl,
                    fullName: fullName,
                    employeeId: employeeId
                });
                $("#registration-page").hide();
                await showMainApp(newUser);
                Swal.fire("ลงทะเบียนสำเร็จ!", "ยินดีต้อนรับสู่ Safety Spot", "success");
            } catch (error) {
                Swal.fire("เกิดข้อผิดพลาด", "ไม่สามารถลงทะเบียนได้", "error");
            }
        });

        $(".nav-link").on("click", function(e) {
            e.preventDefault();
            const pageId = $(this).data("page");
            $(".nav-link").removeClass("active");
            $(this).addClass("active");
            $(".page").removeClass("active");
            $("#" + pageId).addClass("active");
        });

        $(document).on("click", ".btn-join", function() {
            const activityId = $(this).data("activity-id");
            const activityTitle = $(this).data("activity-title");
            $("#activityId-input").val(activityId);
            $("#activity-title-modal").text(activityTitle);
            submissionModal.show();
        });

        $("#submission-form").on("submit", async function(e) {
            e.preventDefault();
            Swal.fire({ title: "กำลังส่งรายงาน...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const payload = {
                lineUserId: lineProfile.userId,
                activityId: $("#activityId-input").val(),
                description: $("#description-input").val().trim(),
                photoUrl: "" // Image upload is not implemented
            };
            try {
                await callApi("submitReport", payload);
                submissionModal.hide();
                $("#submission-form")[0].reset();
                Swal.fire("ส่งรายงานสำเร็จ!", "ขอบคุณสำหรับการมีส่วนร่วม", "success");
            } catch (error) {
                Swal.fire("เกิดข้อผิดพลาด", "ไม่สามารถส่งรายงานได้", "error");
            }
        });

        function updateUserInfoUI(userData) {
            $("#user-profile-pic, #profile-page-pic").attr("src", userData.pictureUrl);
            $("#user-display-name, #profile-page-name").text(userData.fullName);
            $("#user-employee-id").text(`รหัส: ${userData.employeeId}`);
            $("#profile-page-employee-id").text(`รหัสพนักงาน: ${userData.employeeId}`);
            $("#user-score, #profile-page-score").text(userData.totalScore);
        }

        function displayActivitiesUI(activities) {
            const homeList = $("#latest-activities-list");
            const allList = $("#all-activities-list");
            homeList.empty();
            allList.empty();
            if (!activities || activities.length === 0) {
                const noActivityHtml = '<p class="text-center text-muted">ยังไม่มีกิจกรรมในขณะนี้</p>';
                homeList.html(noActivityHtml);
                allList.html(noActivityHtml);
                return;
            }
            activities.forEach(activity => {
                const cardHtml = `<div class="card shadow-sm mb-3 activity-card"><img src="${activity.imageUrl}" class="card-img-top" alt="${activity.title}" style="height: 150px; object-fit: cover;"><div class="card-body"><h5 class="card-title fw-bold">${activity.title}</h5><p class="card-text text-muted small">${activity.description}</p><button class="btn btn-primary w-100 fw-bold py-2 btn-join" data-activity-id="${activity.activityId}" data-activity-title="${activity.title}"><i class="fas fa-plus-circle me-1"></i> เข้าร่วมกิจกรรม</button></div></div>`;
                homeList.append(cardHtml);
                allList.append(cardHtml);
            });
        }
    </script>
</body>
</html>
