<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Spot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0f2f5; }
        #main-app, #registration-page { display: none; }
        .page { display: none; }
        .page.active { display: block; }
        .bottom-nav { box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .nav-link { color: #6c757d; }
        .nav-link.active { color: #0d6efd; }
        #admin-nav-item { color: #dc3545; }
        #admin-nav-item.active { color: #a1232e; }
        .badge-icon { width: 60px; height: 60px; }
        .badge-icon.locked { filter: grayscale(100%); opacity: 0.5; }
        .leaderboard-rank { font-size: 1.2rem; font-weight: bold; min-width: 40px; text-align: center; }
        .leaderboard-item .fa-trophy { color: #ffc107; }
        .table-responsive { max-height: 75vh; }
    </style>
</head>
<body>
    <!-- Registration Page -->
    <div id="registration-page" class="container py-4"><div class="card shadow-sm border-0"><div class="card-body p-4"><h4 class="card-title text-center fw-bold mb-1">ลงทะเบียนใช้งาน</h4><p class="text-center text-muted mb-4">กรุณากรอกข้อมูลเพื่อเริ่มต้นใช้งาน</p><form id="registration-form"><div class="mb-3"><label for="fullName" class="form-label">ชื่อ-นามสกุล</label><input type="text" class="form-control" id="fullName" required placeholder="เช่น สมชาย ใจดี"></div><div class="mb-3"><label for="employeeId" class="form-label">รหัสพนักงาน</label><input type="text" class="form-control" id="employeeId" required placeholder="เช่น 12345"></div><button type="submit" class="btn btn-primary w-100 fw-bold mt-3 py-2">ยืนยันและเริ่มต้นใช้งาน</button></form></div></div></div>

    <!-- Main App -->
    <div id="main-app">
        <main class="container py-3 pb-5 mb-5">
            <div id="home-page" class="page active"><div class="d-flex align-items-center p-3 mb-4 bg-white rounded-3 shadow-sm"><img id="user-profile-pic" src="https://placehold.co/60x60" class="rounded-circle me-3" width="60" height="60"><div><p class="mb-0 text-muted small" id="user-employee-id">รหัส: ...</p><h5 class="mb-0 fw-bold" id="user-display-name">...</h5></div><div class="ms-auto text-end"><div class="fw-bold text-primary"><h4 class="mb-0" id="user-score">0</h4><small>คะแนน</small></div></div></div><h5 class="mb-3">กิจกรรมล่าสุด</h5><div id="latest-activities-list"><p class="text-center text-muted">กำลังโหลดกิจกรรม...</p></div></div>
            <div id="activities-page" class="page"><h4 class="mb-3 fw-bold">กิจกรรมทั้งหมด</h4><div id="all-activities-list"></div></div>
            <div id="leaderboard-page" class="page"><h4 class="mb-3 fw-bold">กระดานผู้นำ</h4><div id="leaderboard-list"></div><div id="leaderboard-loading" class="text-center my-5"><div class="spinner-border" role="status"></div></div></div>
            <div id="profile-page" class="page"><div class="card shadow-sm border-0"><div class="card-body text-center p-4"><img id="profile-page-pic" src="https://placehold.co/80x80" class="rounded-circle mb-3 border border-3 border-primary" width="80" height="80"><h4 id="profile-page-name" class="fw-bold">...</h4><p class="text-muted" id="profile-page-employee-id">รหัสพนักงาน: ...</p><p class="text-muted mb-4">คะแนนสะสม: <span class="fw-bold text-primary" id="profile-page-score">0</span></p><hr><h5 class="mt-4 mb-3">ป้ายรางวัลของฉัน</h5><div id="badges-container" class="d-flex justify-content-center flex-wrap gap-3"></div></div></div></div>
            <div id="admin-page" class="page"><h4 class="fw-bold mb-3">Admin Panel</h4><div class="list-group"><a href="#" id="manage-reports-btn" class="list-group-item list-group-item-action"><i class="fas fa-inbox me-2"></i> จัดการรายงานที่ส่งเข้ามา</a><a href="#" id="manage-activities-btn" class="list-group-item list-group-item-action"><i class="fas fa-tasks me-2"></i> จัดการกิจกรรม</a></div></div>
        </main>
        <nav class="navbar navbar-light bg-white fixed-bottom bottom-nav"><div class="container-fluid d-flex justify-content-around"><a href="#home" class="nav-link active text-center" data-page="home-page"><i class="fas fa-home fs-4"></i><div style="font-size:0.7rem;">หน้าหลัก</div></a><a href="#activities" class="nav-link text-center" data-page="activities-page"><i class="fas fa-tasks fs-4"></i><div style="font-size:0.7rem;">กิจกรรม</div></a><a href="#admin" class="nav-link text-center" data-page="admin-page" id="admin-nav-item" style="display:none;"><i class="fas fa-user-shield fs-4"></i><div style="font-size:0.7rem;">Admin</div></a><a href="#leaderboard" class="nav-link text-center" data-page="leaderboard-page"><i class="fas fa-trophy fs-4"></i><div style="font-size:0.7rem;">อันดับ</div></a><a href="#profile" class="nav-link text-center" data-page="profile-page"><i class="fas fa-user fs-4"></i><div style="font-size:0.7rem;">โปรไฟล์</div></a></div></nav>
    </div>
    
    <!-- Modals -->
    <div class="modal fade" id="submission-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">เข้าร่วมกิจกรรม</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="submission-form"><input type="hidden" id="activityId-input"><h5 id="activity-title-modal" class="fw-bold mb-3"></h5><div class="mb-3"><label class="form-label">รายละเอียดจุดเสี่ยง</label><textarea class="form-control" id="description-input" rows="4" required></textarea></div><button type="submit" class="btn btn-primary w-100 fw-bold mt-3 py-2">ส่งรายงาน</button></form></div></div></div></div>
    <div class="modal fade" id="admin-reports-modal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">จัดการรายงาน (<span id="pending-count-modal">0</span>)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="table-responsive"><table class="table table-striped table-hover mb-0"><thead class="table-dark"><tr><th>รายละเอียด</th><th>Actions</th></tr></thead><tbody id="submissions-table-body"></tbody></table></div><div id="reports-loading" class="text-center my-4"><div class="spinner-border"></div></div><div id="no-reports-message" class="text-center my-4" style="display:none;"><p class="text-muted">ไม่มีรายการที่รอตรวจสอบ</p></div></div></div></div></div>
    <div class="modal fade" id="admin-activities-modal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">จัดการกิจกรรม</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><button id="create-activity-btn" class="btn btn-success mb-3"><i class="fas fa-plus"></i> สร้างกิจกรรมใหม่</button><div id="activities-list-admin"></div></div></div></div></div>
    <div class="modal fade" id="activity-form-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="activity-form-title">สร้างกิจกรรมใหม่</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="activity-form"><input type="hidden" id="form-activity-id"><div class="mb-3"><label class="form-label">หัวข้อ</label><input type="text" class="form-control" id="form-activity-title" required></div><div class="mb-3"><label class="form-label">คำอธิบาย</label><textarea class="form-control" id="form-activity-desc" rows="3" required></textarea></div><div class="mb-3"><label class="form-label">Image URL</label><input type="text" class="form-control" id="form-activity-image" required></div><button type="submit" class="btn btn-primary w-100">บันทึก</button></form></div></div></div></div>

    <!-- JS Libraries -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const SERVER_URL = "https://script.google.com/macros/s/AKfycbwxqz4oyc5oOP_81fCeXbINoW-WLOv0l2Tmb3ZTc13B944uY8q8P1V1JPbdzGP4LTnexw/exec";
        const LIFF_ID = "2007053300-9xLKdwZp";
        let lineProfile = {}; 
        let allModals = {};

        $(document).ready(function() {
            ['submission', 'admin-reports', 'admin-activities', 'activity-form'].forEach(id => { allModals[id] = new bootstrap.Modal(document.getElementById(`${id}-modal`)); });
            initializeApp();
            $('a[data-page="leaderboard-page"]').on('click', loadLeaderboard);
            $('a[data-page="profile-page"]').on('click', loadUserBadges);
        });

        async function initializeApp() {
            try {
                Swal.fire({ title: 'กำลังเริ่มต้น...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                lineProfile = await liff.getProfile();
                const result = await callApi('getUserProfile', { lineUserId: lineProfile.userId });
                if (result.registered) { showMainApp(result.user); } 
                else { Swal.close(); $('#registration-page').fadeIn(); }
            } catch (error) { Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดแอปได้', 'error'); }
        }

        async function showMainApp(userData) {
            updateUserInfoUI(userData);
            if (userData.isAdmin) {
                $('#admin-nav-item').show();
                $('#manage-reports-btn').on('click', () => { loadPendingSubmissions(); allModals['admin-reports'].show(); });
                $('#manage-activities-btn').on('click', () => { loadAllActivitiesForAdmin(); allModals['admin-activities'].show(); });
                $('#create-activity-btn').on('click', () => { $('#activity-form-title').text('สร้างกิจกรรมใหม่'); $('#activity-form')[0].reset(); $('#form-activity-id').val(''); allModals['activity-form'].show(); });
            }
            const activities = await callApi('getActivities');
            displayActivitiesUI(activities);
            $('#main-app').fadeIn();
            Swal.close();
        }

        function callApi(action, payload = {}, method = 'GET') {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    if(script && script.parentNode) document.body.removeChild(script);
                    if (data.status === 'success') { resolve(data.data); } 
                    else { reject(new Error(data.message)); }
                };
                let script;
                if (method === 'GET') {
                    script = document.createElement('script');
                    const payloadStr = encodeURIComponent(JSON.stringify(payload));
                    script.src = `${SERVER_URL}?callback=${callbackName}&action=${action}&payload=${payloadStr}`;
                    document.body.appendChild(script);
                } else { // POST
                    $.ajax({
                        url: `${SERVER_URL}?callback=${callbackName}`,
                        type: 'POST',
                        crossDomain: true,
                        data: JSON.stringify({ action, payload }),
                        contentType: 'text/plain;charset=utf-8',
                        dataType: 'jsonp'
                    }).fail(() => reject(new Error('POST request failed')));
                }
            });
        }
        
        // --- EVENT LISTENERS ---
        $('.nav-link').on('click',function(e){e.preventDefault();const pageId=$(this).data('page');if(pageId){$('.nav-link').removeClass('active');$(this).addClass('active');$('.page').removeClass('active');$('#'+pageId).addClass('active');}});
        $('#registration-form').on('submit',async function(e){e.preventDefault();const fullName=$('#fullName').val().trim();const employeeId=$('#employeeId').val().trim();if(!fullName||!employeeId){Swal.fire('ข้อมูลไม่ครบ','...','warning');return;} Swal.fire({title:'กำลังบันทึก...',didOpen:()=>Swal.showLoading()});try{const newUser=await callApi("registerUser",{lineUserId:lineProfile.userId,displayName:lineProfile.displayName,pictureUrl:lineProfile.pictureUrl,fullName:fullName,employeeId:employeeId}, 'POST');$('#registration-page').hide();await showMainApp(newUser);Swal.fire('สำเร็จ!','...','success');}catch(error){Swal.fire('ผิดพลาด','...','error');}});
        $(document).on('click','.btn-join',function(){const activityId=$(this).data('activity-id');const activityTitle=$(this).data('activity-title');$('#activityId-input').val(activityId);$('#activity-title-modal').text(activityTitle);allModals.submission.show();});
        $('#submission-form').on('submit', async function(e){e.preventDefault();Swal.fire({title:'กำลังส่ง...',didOpen:()=>Swal.showLoading()});const payload={lineUserId:lineProfile.userId,activityId:$('#activityId-input').val(),description:$('#description-input').val().trim()};callApi('submitReport',payload,'POST').then(()=>{allModals.submission.hide();$('#submission-form')[0].reset();Swal.fire('สำเร็จ!','...','success');}).catch(error=>{Swal.fire('ผิดพลาด','...','error');});});
        $('#activity-form').on('submit', async function(e){e.preventDefault();Swal.fire({title:'กำลังบันทึก...',didOpen:()=>Swal.showLoading()});const payload={activityId:$('#form-activity-id').val(),title:$('#form-activity-title').val(),description:$('#form-activity-desc').val(),imageUrl:$('#form-activity-image').val()};const action=payload.activityId?'updateActivity':'createActivity';try{await callApi(action,payload,'POST');allModals['activity-form'].hide();Swal.fire('สำเร็จ!','...','success');loadAllActivitiesForAdmin();}catch(e){Swal.fire('ผิดพลาด','...','error');}});
        $(document).on('click', '.btn-approve, .btn-reject', function(){const btn=$(this);const action=btn.hasClass('btn-approve')?'approveSubmission':'rejectSubmission';const id=btn.data('id');const row=btn.data('row');btn.prop('disabled',true).parent().find('button').prop('disabled',true);btn.html('<span class="spinner-border spinner-border-sm"></span>');callApi(action,{submissionId:id,rowIndex:row},'POST').then(()=>{ $(`#row-${id}`).fadeOut(500,()=>$(this).remove());}).catch(e=>{Swal.fire('Error','...','error');btn.prop('disabled',false).parent().find('button').prop('disabled',false);btn.html(btn.hasClass('btn-approve')?'✓':'✗');});});
        $(document).on('click', '.btn-edit-activity', function(){const data=JSON.parse($(this).data('id'));$('#activity-form-title').text('แก้ไขกิจกรรม');$('#form-activity-id').val(data.activityId);$('#form-activity-title').val(data.title);$('#form-activity-desc').val(data.description);$('#form-activity-image').val(data.imageUrl);allModals['activity-form'].show();});
        $(document).on('click', '.btn-toggle-activity', function(){const btn=$(this);const id=btn.data('id');btn.prop('disabled',true);callApi('toggleActivityStatus',{activityId:id}).then(res=>{btn.prop('disabled',false);loadAllActivitiesForAdmin();});});

        // --- UI FUNCTIONS ---
        function updateUserInfoUI(userData){$('#user-profile-pic, #profile-page-pic').attr('src',userData.pictureUrl);$('#user-display-name, #profile-page-name').text(userData.fullName);$('#user-employee-id').text(`รหัส: ${userData.employeeId}`);$('#profile-page-employee-id').text(`รหัสพนักงาน: ${userData.employeeId}`);$('#user-score, #profile-page-score').text(userData.totalScore);}
        function displayActivitiesUI(activities){const lists=$('#latest-activities-list, #all-activities-list');lists.empty();if(!activities||activities.length===0){lists.html('<p class="text-center text-muted">ยังไม่มีกิจกรรม</p>');return;} activities.forEach(act=>{const cardHtml=`<div class="card shadow-sm mb-3"><img src="${act.imageUrl}" class="card-img-top" style="height:150px;object-fit:cover;"><div class="card-body"><h5 class="card-title fw-bold">${act.title}</h5><p class="card-text text-muted small">${act.description}</p><button class="btn btn-primary w-100 fw-bold py-2 btn-join" data-activity-id="${act.activityId}" data-activity-title="${act.title}"><i class="fas fa-plus-circle me-1"></i> เข้าร่วม</button></div></div>`;lists.append(cardHtml);});}
        function loadLeaderboard(){const list=$('#leaderboard-list');const loading=$('#leaderboard-loading');list.empty();loading.show();callApi('getLeaderboard').then(users=>{loading.hide();if(users.length===0){list.html('<p class="text-center text-muted">ยังไม่มีข้อมูล</p>');return;} users.forEach((user,index)=>{const rank=index+1;let rankDisplay;if(rank===1)rankDisplay='<i class="fas fa-trophy"></i>';else if(rank===2)rankDisplay='<i class="fas fa-medal text-secondary"></i>';else if(rank===3)rankDisplay='<i class="fas fa-medal" style="color:#cd7f32;"></i>';else rankDisplay=rank;const itemHtml=`<div class="d-flex align-items-center p-2 mb-2 bg-white rounded-3 shadow-sm"><div class="leaderboard-rank me-3">${rankDisplay}</div><img src="${user.pictureUrl}" class="rounded-circle me-3" width="45" height="45"><div class="flex-grow-1"><div class="fw-bold">${user.fullName}</div></div><div class="fw-bold text-primary">${user.totalScore} คะแนน</div></div>`;list.append(itemHtml);});}).catch(error=>{loading.hide();list.html('<p class="text-center text-danger">โหลดข้อมูลไม่ได้</p>');});}
        function loadUserBadges(){const container=$('#badges-container');container.html('<div class="spinner-border"></div>');callApi('getUserBadges',{lineUserId:lineProfile.userId}).then(badges=>{container.empty();if(badges.length===0){container.html('<p class="text-muted">ยังไม่มีป้ายรางวัล</p>');return;} badges.forEach(b=>{const lockClass=b.isEarned?'':'locked';const html=`<div class="text-center" title="${b.desc}"><img src="${b.img}" class="badge-icon ${lockClass}"><div class="small">${b.name}</div></div>`;container.append(html);});}).catch(e=>{container.html('<p class="text-danger">โหลดป้ายรางวัลไม่ได้</p>')})}
        function loadPendingSubmissions(){const tableBody=$('#submissions-table-body');$('#reports-loading').show();$('#no-reports-message').hide();tableBody.empty();callApi('getPendingSubmissions').then(subs=>{ $('#reports-loading').hide();$('#pending-count-modal').text(subs.length);if(subs.length===0){$('#no-reports-message').show();return;} subs.forEach(s=>{const row=`<tr id="row-${s.submissionId}"><td><div class="small text-muted">${s.submissionId.substring(0,8)}...</div>${s.description}</td><td><button class="btn btn-success btn-sm btn-approve" data-id="${s.submissionId}" data-row="${s.rowIndex}">✓</button><button class="btn btn-danger btn-sm btn-reject" data-id="${s.submissionId}" data-row="${s.rowIndex}">✗</button></td></tr>`;tableBody.append(row);});});}
        function loadAllActivitiesForAdmin(){const list=$('#activities-list-admin');list.html('<div class="spinner-border"></div>');callApi('getAllActivities').then(acts=>{list.empty();acts.forEach(a=>{const statusBadge=a.status==='active'?'bg-success':'bg-secondary';const btnText=a.status==='active'?'Deactivate':'Activate';const btnClass=a.status==='active'?'btn-secondary':'btn-success';const html=`<div class="card mb-2"><div class="card-body d-flex align-items-center"><div><span class="badge ${statusBadge} me-2">${a.status}</span><strong>${a.title}</strong></div><div class="ms-auto"><button class="btn btn-sm btn-primary btn-edit-activity me-1" data-id='${JSON.stringify(a)}'>Edit</button><button class="btn btn-sm ${btnClass} btn-toggle-activity" data-id="${a.activityId}">${btnText}</button></div></div></div>`;list.append(html);});});}
    </script>
</body>
</html>
